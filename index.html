<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body { margin:0; padding:0; background:#0b0b0b; color:#fff; font-family:'SF Pro', sans-serif; overflow:hidden; }
canvas { display:block; }
#ui { position: fixed; top:10px; right:10px; background: rgba(0,0,0,0.7); padding:12px; border-radius:10px; width:260px; font-size:14px; }
#leaderboard { margin-top:8px; max-height:180px; overflow-y:auto; font-size:13px; position:relative; }
.lb-row { display:flex; justify-content:space-between; opacity:0.85; position:relative; animation: floatUpDown 2s infinite alternate; }
@keyframes floatUpDown { 0%{top:0px;} 100%{top:4px;} }
.comboText { position:absolute; top:10px; left:50%; transform:translateX(-50%); font-weight:bold; font-style:italic; font-size:22px; animation: floatCombo 1s ease-out forwards; pointer-events:none; }
@keyframes floatCombo { 0%{opacity:1; top:10px;} 100%{opacity:0; top:-40px;} }
button { width:100%; padding:6px; margin:4px 0; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }
button:hover{opacity:0.85;}
</style>
</head>
<body>

<div id="ui">
  <div><b>Player</b></div>
  <hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
  <hr>
  <b>Leaderboard</b>
  <div id="leaderboard"></div>
  <button id="idleBtn">IDLE MODE</button>
  <button id="exitIdleBtn" style="display:none;">EXIT IDLE MODE</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth;
canvas.height = innerHeight;
window.addEventListener('resize',()=>{canvas.width=innerWidth;canvas.height=innerHeight;});

/* BACKGROUND */
const bgImg = new Image(); bgImg.src="bg.png";
const bgImg2 = new Image(); bgImg2.src="goonerola.png";
const bgObj={x:canvas.width/2,y:canvas.height/2,vx:0.4,vy:0.4,size:39};
const bgObj2={x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:0.6,vy:0.6,size:36};

/* PLAYER */
let player={x:canvas.width/2,y:canvas.height/2,r:18,angle:0,tokens:0,health:100,rainbow:false};
let currentShapeSides=3;

/* GAME DATA */
let bullets=[],enemies=[],particles=[];
let keys={},idleMode=false,idleInterval=null;
let combo=0,mass=0,difficulty=1,hUses=12;

/* BOSS DATA */
let boss=null;
let bossSpawnCount=0;

/* FIRE */
function fireSingle(){
  bullets.push({x:player.x,y:player.y,vx:Math.cos(player.angle)*6,vy:Math.sin(player.angle)*6});
}

/* EVOLUTION */
function evolve(){
  if(player.tokens<5) currentShapeSides=3;
  else if(player.tokens<10) currentShapeSides=4;
  else if(player.tokens<15) currentShapeSides=5;
  else if(player.tokens<20) currentShapeSides=6;
  else if(player.tokens<25) currentShapeSides=7;
  else if(player.tokens<30) currentShapeSides=8;
  else if(player.tokens<35) currentShapeSides=9;
  else if(player.tokens<40) currentShapeSides=10;
  else currentShapeSides=100;
}

/* ENEMIES */
function spawnEnemy(){
  enemies.push({x:Math.random()<0.5?-20:canvas.width+20,y:Math.random()*canvas.height,r:8});
}
setInterval(spawnEnemy,800);
setInterval(()=>hUses=12,60000);

/* BOSS SPAWN */
function spawnBoss(){
  bossSpawnCount++;
  boss={
    x:Math.random()<0.5?-80:canvas.width+80,
    y:Math.random()*canvas.height,
    r:player.r*1.2,
    hp:30+(bossSpawnCount-1)*5
  };
}
setInterval(spawnBoss,90000);

/* UPDATE */
function update(){
  if(keys.w) player.y-=4;
  if(keys.s) player.y+=4;
  if(keys.a) player.x-=4;
  if(keys.d) player.x+=4;

  bullets.forEach((b,i)=>{
    b.x+=b.vx; b.y+=b.vy;
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1);
  });

  enemies.forEach((e,i)=>{
    const dx=player.x-e.x,dy=player.y-e.y,d=Math.hypot(dx,dy)||1;
    e.x+=dx/d*(0.7+difficulty*0.2);
    e.y+=dy/d*(0.7+difficulty*0.2);
    if(d<player.r+e.r){
      combo=0; player.rainbow=false;
      enemies.splice(i,1);
    }
  });

  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(Math.hypot(b.x-e.x,b.y-e.y)<e.r){
        bullets.splice(bi,1);
        enemies.splice(ei,1);
        mass++; player.tokens++; evolve(); combo++;
      }
    });
  });

  /* BOSS UPDATE */
  if(boss){
    const dx=player.x-boss.x,dy=player.y-boss.y,d=Math.hypot(dx,dy)||1;
    boss.x+=dx/d*0.9;
    boss.y+=dy/d*0.9;

    bullets.forEach((b,bi)=>{
      if(Math.hypot(b.x-boss.x,b.y-boss.y)<boss.r){
        bullets.splice(bi,1);
        boss.hp--;
        if(boss.hp<=0) boss=null;
      }
    });

    if(boss && (boss.x<-150||boss.x>canvas.width+150||boss.y<-150||boss.y>canvas.height+150)){
      boss=null;
    }
  }

  player.x=Math.max(player.r,Math.min(canvas.width-player.r,player.x));
  player.y=Math.max(player.r,Math.min(canvas.height-player.r,player.y));

  document.getElementById('mass').textContent=mass;
  document.getElementById('tokens').textContent=player.tokens;
}

/* DRAW */
function draw(){
  ctx.fillStyle="rgba(11,11,11,0.3)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  drawPlayerShape();

  bullets.forEach(b=>ctx.fillRect(b.x,b.y,3,3));
  enemies.forEach(e=>{ctx.fillStyle='red';ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();});

  if(boss){
    ctx.save();
    ctx.translate(boss.x,boss.y);
    ctx.shadowColor='rgba(210,180,255,0.9)';
    ctx.shadowBlur=25;
    ctx.fillStyle='rgb(210,180,255)';
    ctx.beginPath();
    for(let i=0;i<6;i++){
      const a=i*Math.PI*2/6-Math.PI/2;
      ctx.lineTo(Math.cos(a)*boss.r,Math.sin(a)*boss.r);
    }
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    ctx.fillStyle='#fff';
    ctx.textAlign='center';
    ctx.fillText(boss.hp,boss.x,boss.y-boss.r-10);
  }
}

/* PLAYER DRAW */
function drawPlayerShape(){
  ctx.save();
  ctx.translate(player.x,player.y);
  ctx.rotate(player.angle);
  ctx.fillStyle='#4caf50';
  ctx.beginPath();
  for(let i=0;i<currentShapeSides;i++){
    const a=i*Math.PI*2/currentShapeSides;
    ctx.lineTo(Math.cos(a)*player.r,Math.sin(a)*player.r);
  }
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* LOOP */
function loop(){update();draw();requestAnimationFrame(loop);}
loop();

/* INPUT */
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key===' ') fireSingle();
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
</script>
</body>
</html>
