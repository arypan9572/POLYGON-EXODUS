<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body {
  margin:0;
  padding:0;
  background:#0b0b0b;
  color:#fff;
  font-family:'SF Pro', sans-serif;
  overflow:hidden;
}
canvas { display:block; }

#ui {
  position: fixed;
  top:10px;
  right:10px;
  background: rgba(0,0,0,0.7);
  padding:12px;
  border-radius:10px;
  width:260px;
  font-size:14px;
}

#leaderboard {
  margin-top:8px;
  max-height:180px;
  overflow-y:auto;
  font-size:13px;
  position:relative;
}

.lb-row {
  display:flex;
  justify-content:space-between;
  opacity:0.85;
  position:relative;
  animation: floatUpDown 2s infinite alternate;
}

@keyframes floatUpDown {
  0%{top:0px;}
  100%{top:4px;}
}

.comboText {
  position: absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  font-style:italic;
  font-size:22px;
  animation: floatCombo 1s ease-out forwards;
  pointer-events:none;
  font-family: 'SF Pro', sans-serif;
}

@keyframes floatCombo {
  0%{opacity:1; top:10px;}
  100%{opacity:0; top:-40px;}
}

button {
  width:100%;
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
button:hover{opacity:0.85;}
</style>
</head>
<body>

<div id="ui">
  <div><b>Player</b></div>
  <hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
  <hr>
  <b>Leaderboard</b>
  <div id="leaderboard"></div>
  <button id="idleBtn">IDLE MODE</button>
  <button id="exitIdleBtn" style="display:none;">EXIT IDLE MODE</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth;
canvas.height = innerHeight;

window.addEventListener('resize',()=>{
  canvas.width=innerWidth;
  canvas.height=innerHeight;
});

/* ================= BACKGROUND IMAGE ================= */
const bgImg = new Image();
bgImg.src = "bg.png";

const bgImg2 = new Image();
bgImg2.src = "goonerola.png";

const bgObj = {
  x: canvas.width/2,
  y: canvas.height/2,
  vx: (Math.random()*0.4+0.1)*(Math.random()<0.5?-1:1),
  vy: (Math.random()*0.4+0.1)*(Math.random()<0.5?-1:1),
  size: 39
};

const bgObj2 = {
  x: Math.random() * canvas.width,
  y: Math.random() * canvas.height,
  vx: (Math.random()*0.5+0.2)*(Math.random()<0.5?-1:1),
  vy: (Math.random()*0.5+0.2)*(Math.random()<0.5?-1:1),
  size: 36
};

/* ================= PLAYER ================= */
let player = {
  x:canvas.width/2,
  y:canvas.height/2,
  r:18,
  angle:0,
  tokens:0,
  health:100,
  rainbow:false
};

let currentShapeSides = 3;
let bullets=[], enemies=[], particles=[], bosses=[];
let keys={}, idleMode=false, idleInterval=null;
let combo=0, mass=0;
let difficulty = 1;
let hUses = 12;
let bossIndex = 0;

/* ================= FIRE ================= */
function fireSingle(){
  if(player.rainbow){
    const spread=0.2;
    for(let i=-1;i<=2;i++){
      const a=player.angle+i*spread;
      bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*5,vy:Math.sin(a)*5,rainbow:true});
    }
  } else {
    bullets.push({x:player.x,y:player.y,vx:Math.cos(player.angle)*5,vy:Math.sin(player.angle)*5,rainbow:false});
  }
}

function fireSpread(){
  const count=8;
  for(let i=0;i<count;i++){
    const a=i*Math.PI*2/count+player.angle;
    bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*6,vy:Math.sin(a)*6,rainbow:player.rainbow});
  }
}

/* ================= EVOLUTION ================= */
function evolve(){
  const t = player.tokens;
  if(t<5) currentShapeSides=3;
  else if(t<10) currentShapeSides=4;
  else if(t<20) currentShapeSides=5;
  else if(t<30) currentShapeSides=6;
  else if(t<40) currentShapeSides=7;
  else if(t<50) currentShapeSides=8;
  else if(t<60) currentShapeSides=9;
  else if(t<70) currentShapeSides=10;
  else if(t<80) currentShapeSides=2;
  else if(t<90) currentShapeSides=50;
  else if(t<100) currentShapeSides=60;
  else if(t<110) currentShapeSides=12;
  else if(t<120) currentShapeSides=14;
  else if(t<130) currentShapeSides=16;
  else if(t<140) currentShapeSides=18;
  else if(t<150) currentShapeSides=20;
  else if(t<160) currentShapeSides=24;
  else if(t<170) currentShapeSides=30;
  else if(t<180) currentShapeSides=36;
  else if(t<190) currentShapeSides=40;
  else currentShapeSides=100;
}

/* ================= ENEMIES ================= */
function spawnEnemy(){
  enemies.push({
    x:Math.random()<0.5?-20:canvas.width+20,
    y:Math.random()*canvas.height,
    r:8,
    hp:1,
    gradient:"red"
  });
}
setInterval(spawnEnemy,1000);
setInterval(()=>{ hUses = 12; }, 60000);

/* ================= BOSSES ================= */
function spawnBoss(){
  const baseSize = player.r*1.5*Math.pow(1.17,bossIndex);
  const hp = 30 + bossIndex*2;
  bosses.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    r: baseSize,
    hp: hp,
    maxHp: hp,
    vx: (Math.random()*2-1)*1.5,
    vy: (Math.random()*2-1)*1.5,
    flash: 0
  });
  bossIndex++;
}
setInterval(spawnBoss, 150000);

/* ================= EXPLOSION ================= */
function createExplosion(x,y){
  for(let i=0;i<12;i++){
    particles.push({x,y,r:Math.random()*4+2,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,alpha:1});
  }
}

/* ================= COMBO ================= */
function showCombo(n){
  const d=document.createElement('div');
  d.className='comboText';
  d.textContent='COMBO x'+n;
  d.style.color=player.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff';
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1000);
}

/* ================= UPDATE ================= */
function update(){
  if(!idleMode){
    if(keys.w) player.y-=3;
    if(keys.s) player.y+=3;
    if(keys.a) player.x-=3;
    if(keys.d) player.x+=3;
  } else {
    player.x+=(canvas.width/2-player.x)*0.05;
    player.y+=(canvas.height/2-player.y)*0.05;
  }

  player.angle+=0.05;

  bullets.forEach(b=>{b.x+=b.vx; b.y+=b.vy;});
  enemies.forEach(e=>{
    const dx=player.x-e.x, dy=player.y-e.y;
    const d=Math.hypot(dx,dy)||1;
    e.x += dx/d*(0.5+difficulty*0.15);
    e.y += dy/d*(0.5+difficulty*0.15);
    if(d < player.r+e.r){ combo=0; player.rainbow=false; }
  });

  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(Math.hypot(b.x-e.x,b.y-e.y)<e.r){
        bullets.splice(bi,1);
        enemies.splice(ei,1);
        createExplosion(e.x,e.y);
        mass++; player.tokens++; evolve(); combo++;
        if(mass % 25 ===0) difficulty++;
        if(combo>1) showCombo(combo);
        if(combo>=35&&!player.rainbow) player.rainbow=true;
      }
    });
  });

  bullets.forEach((b,bi)=>{
    bosses.forEach((boss,bi2)=>{
      if(Math.hypot(b.x-boss.x,b.y-boss.y)<boss.r){
        bullets.splice(bi,1);
        boss.hp--;
        createExplosion(boss.x,boss.y);
        if(boss.hp<=0){
          bosses.splice(bi2,1);
          player.tokens+=100;
        }
        mass++; evolve(); combo++; if(combo>1) showCombo(combo);
        if(combo>=35&&!player.rainbow) player.rainbow=true;
      }
    });
  });

  // MOVE BOSSES
  bosses.forEach(b=>{
    b.x += b.vx; b.y += b.vy;
    if(b.x<b.r || b.x>canvas.width-b.r) b.vx*=-1;
    if(b.y<b.r || b.y>canvas.height-b.r) b.vy*=-1;
    b.flash += 0.05;
  });

  particles.forEach(p=>{p.x+=p.vx; p.y+=p.vy; p.alpha-=0.03;});
  particles = particles.filter(p=>p.alpha>0);

  bgObj.x+=bgObj.vx; bgObj.y+=bgObj.vy;
  if(bgObj.x<bgObj.size||bgObj.x>canvas.width-bgObj.size) bgObj.vx*=-1;
  if(bgObj.y<bgObj.size||bgObj.y>canvas.height-bgObj.size) bgObj.vy*=-1;
  bgObj2.x+=bgObj2.vx; bgObj2.y+=bgObj2.vy;
  if(bgObj2.x<bgObj2.size||bgObj2.x>canvas.width-bgObj2.size) bgObj2.vx*=-1;
  if(bgObj2.y<bgObj2.size||bgObj2.y>canvas.height-bgObj2.size) bgObj2.vy*=-1;

  document.getElementById('mass').textContent=mass;
  document.getElementById('tokens').textContent=player.tokens;
  document.getElementById('tier').textContent=getShapeName(currentShapeSides);

  player.x=Math.max(player.r,Math.min(canvas.width-player.r,player.x));
  player.y=Math.max(player.r,Math.min(canvas.height-player.r,player.y));
}

/* ================= DRAW ================= */
function draw(){
  ctx.fillStyle="rgba(11,11,11,0.25)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(bgImg.complete){ ctx.globalAlpha=0.25; ctx.drawImage(bgImg,bgObj.x-bgObj.size/2,bgObj.y-bgObj.size/2,bgObj.size,bgObj.size); ctx.globalAlpha=1;}
  if(bgImg2.complete){ ctx.globalAlpha=0.25; ctx.drawImage(bgImg2,bgObj2.x-bgObj2.size/2,bgObj2.y-bgObj2.size/2,bgObj2.size,bgObj2.size); ctx.globalAlpha=1;}

  drawPlayerShape();

  bullets.forEach(b=>{
    ctx.fillStyle=b.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff';
    ctx.fillRect(b.x,b.y,3,3);
  });

  enemies.forEach(e=>{
    ctx.fillStyle='red';
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fill();
  });

  bosses.forEach(b=>{
    // Glow gradient
    const grd = ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
    grd.addColorStop(0,'white');
    grd.addColorStop(0.5,'purple');
    grd.addColorStop(1,'transparent');
    ctx.fillStyle = grd;
    ctx.beginPath();
    const sides=5;
    for(let i=0;i<sides;i++){
      const a=i*Math.PI*2/sides - Math.PI/2;
      ctx.lineTo(Math.cos(a)*b.r+ b.x, Math.sin(a)*b.r+b.y);
    }
    ctx.closePath();
    ctx.fill();

    // HP number
    ctx.save();
    ctx.translate(b.x,b.y-b.r-15);
    ctx.font='italic 18px "SF Pro", sans-serif';
    ctx.textAlign='center';
    ctx.fillStyle=`hsl(${Date.now()%360},100%,50%)`;
    ctx.fillText(`${b.hp} HP`,0,0);
    ctx.restore();
  });

  particles.forEach(p=>{
    ctx.fillStyle=`rgba(255,0,0,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fill();
  });
}

/* ================= DRAW PLAYER SHAPE ================= */
function drawPlayerShape(){
  const sides = currentShapeSides;
  ctx.save();
  ctx.translate(player.x,player.y);
  ctx.rotate(player.angle);

  ctx.fillStyle = player.rainbow ? `hsl(${Date.now()%360},100%,50%)` : '#4caf50';
  ctx.beginPath();

  if([2,3,4,5,6,7,8,9,10,12,14,16,18,20,24,30,36,40,50,60,100].includes(sides)){
    for(let i=0;i<sides;i++){
      const a=i*Math.PI*2/sides - Math.PI/2;
      const r = i%2!==0 && sides>10 ? player.r/2 : player.r;
      ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);
    }
    ctx.closePath();
  } else if(sides===100){
    ctx.arc(0,0,player.r,0,Math.PI*2);
  }

  ctx.fill();
  ctx.restore();
}

/* ================= LOOP ================= */
function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();

/* ================= INPUT ================= */
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key===' '&&!idleMode) fireSingle();
  if(e.key.toLowerCase()==='h' && !idleMode && hUses>0){ fireSpread(); hUses--; }
});
window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });

/* ================= IDLE MODE ================= */
document.getElementById('idleBtn').onclick=()=>{
  if(idleMode) return;
  idleMode=true;
  document.getElementById('idleBtn').style.display='none';
  document.getElementById('exitIdleBtn').style.display='block';
  idleInterval=setInterval(()=>{
    for(let i=0;i<currentShapeSides;i++) fireSingle();
    if(combo>=10) fireSpread();
  },1000);
};
document.getElementById('exitIdleBtn').onclick=()=>{
  idleMode=false;
  clearInterval(idleInterval);
  idleInterval=null;
  document.getElementById('exitIdleBtn').style.display='none';
  document.getElementById('idleBtn').style.display='block';
};
</script>
</body>
</html>
