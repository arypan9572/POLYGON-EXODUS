<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body { margin:0; padding:0; background:#0b0b0b; color:#fff; font-family:'SF Pro', sans-serif; overflow:hidden; }
canvas { display:block; }
#ui { position: fixed; top:10px; right:10px; background: rgba(0,0,0,0.7); padding:12px; border-radius:10px; width:260px; font-size:14px; }
#leaderboard { margin-top:8px; max-height:180px; overflow-y:auto; font-size:13px; position:relative; }
.lb-row { display:flex; justify-content:space-between; opacity:0.85; position:relative; animation: floatUpDown 2s infinite alternate; }
@keyframes floatUpDown { 0%{top:0px;} 100%{top:4px;} }
.comboText { position:absolute; top:10px; left:50%; transform:translateX(-50%); font-weight:bold; font-style:italic; font-size:22px; animation: floatCombo 1s ease-out forwards; pointer-events:none; }
@keyframes floatCombo { 0%{opacity:1; top:10px;} 100%{opacity:0; top:-40px;} }
button { width:100%; padding:6px; margin:4px 0; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }
button:hover{opacity:0.85;}
#circleMsg {
  position: fixed;
  bottom: -50px;
  left: 50%;
  transform: translateX(-50%);
  font-size:20px;
  font-style: italic;
  font-weight: 600;
  font-family: 'SF Pro', sans-serif;
  pointer-events:none;
  white-space: nowrap;
}
</style>
</head>
<body>

<div id="ui">
  <div><b>Player</b></div>
  <hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
  <hr>
  <b>Leaderboard</b>
  <div id="leaderboard"></div>
  <button id="idleBtn">IDLE MODE</button>
  <button id="exitIdleBtn" style="display:none;">EXIT IDLE MODE</button>
  <button id="saveLoadBtn">SAVE / LOAD</button>
</div>

<canvas id="game"></canvas>

<div id="circleMsg"></div>

<div id="savePanel" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999;">
  <div style="width:420px;background:#111;border:2px solid #555;padding:14px;margin:10% auto;border-radius:10px;">
    <b>Save / Load Game</b>
    <textarea id="saveText" style="width:100%;height:120px;margin-top:10px;background:#000;color:#0f0;font-family:monospace;resize:none;"></textarea>
    <button id="saveBtn">GENERATE SAVE</button>
    <button id="loadBtn">LOAD GAME</button>
    <button id="closeSave">CLOSE</button>
  </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
window.addEventListener('resize',()=>{canvas.width=innerWidth; canvas.height=innerHeight;});

/* BACKGROUND */
const bgImg = new Image(); bgImg.src="bg.png";
const bgImg2 = new Image(); bgImg2.src="goonerola.png";
const bgObj={x:canvas.width/2,y:canvas.height/2,vx:(Math.random()*0.6+0.2)*(Math.random()<0.5?-1:1),vy:(Math.random()*0.6+0.2)*(Math.random()<0.5?-1:1),size:39};
const bgObj2={x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:(Math.random()*0.7+0.3)*(Math.random()<0.5?-1:1),vy:(Math.random()*0.7+0.3)*(Math.random()<0.5?-1:1),size:36};

/* PLAYER */
let player={x:canvas.width/2,y:canvas.height/2,r:18,angle:0,tokens:0,health:100,rainbow:false};
let currentShapeSides=3;

/* GAME DATA */
let bullets=[],enemies=[],particles=[];
let keys={},idleMode=false,idleInterval=null;
let combo=0,mass=0,difficulty=1,hUses=12;

/* BLUE CUBE */
let blueCube = null;
let nextCubeSpawn = Date.now() + 30000; // 30s for first cube
let enemyOriginalSpeeds = new Map(); // stores original speeds for reset

function updateBlueCube(deltaTime){
  // spawn cube
  if(!blueCube && Date.now()>=nextCubeSpawn){
    blueCube = { x:canvas.width/2, y:canvas.height/2, size:25, speed:3 }; // slower, centered
  }

  if(blueCube){
    const dx = blueCube.x - player.x;
    const dy = blueCube.y - player.y;
    const dist = Math.hypot(dx,dy)||1;
    const moveDist = blueCube.speed * deltaTime / 1000;
    blueCube.x += (dx/dist) * moveDist;
    blueCube.y += (dy/dist) * moveDist;

    if(dist < blueCube.size/2 + player.r){
      enemies.forEach(e=>{
        if(!enemyOriginalSpeeds.has(e)) enemyOriginalSpeeds.set(e,0.7+difficulty*0.2); // store original
        e.speed = (0.7+difficulty*0.2)*0.2;
      });
      blueCube = null;
      nextCubeSpawn = Date.now() + (30000 + Math.random()*30000);
      setTimeout(()=>{ enemies.forEach(e=>{e.speed = enemyOriginalSpeeds.get(e) || (0.7+difficulty*0.2); }); enemyOriginalSpeeds.clear(); },5000);
    }
  }
}

function drawBlueCube(){
  if(!blueCube) return;
  // glow pulse
  const glow = 10 + Math.sin(Date.now()/300)*10;
  ctx.save();
  ctx.shadowBlur = glow;
  ctx.shadowColor = "blue";
  ctx.fillStyle = "blue";
  const r = blueCube.size/5; // rounded corners
  ctx.beginPath();
  ctx.moveTo(blueCube.x - blueCube.size/2 + r, blueCube.y - blueCube.size/2);
  ctx.lineTo(blueCube.x + blueCube.size/2 - r, blueCube.y - blueCube.size/2);
  ctx.quadraticCurveTo(blueCube.x + blueCube.size/2, blueCube.y - blueCube.size/2, blueCube.x + blueCube.size/2, blueCube.y - blueCube.size/2 + r);
  ctx.lineTo(blueCube.x + blueCube.size/2, blueCube.y + blueCube.size/2 - r);
  ctx.quadraticCurveTo(blueCube.x + blueCube.size/2, blueCube.y + blueCube.size/2, blueCube.x + blueCube.size/2 - r, blueCube.y + blueCube.size/2);
  ctx.lineTo(blueCube.x - blueCube.size/2 + r, blueCube.y + blueCube.size/2);
  ctx.quadraticCurveTo(blueCube.x - blueCube.size/2, blueCube.y + blueCube.size/2, blueCube.x - blueCube.size/2, blueCube.y + blueCube.size/2 - r);
  ctx.lineTo(blueCube.x - blueCube.size/2, blueCube.y - blueCube.size/2 + r);
  ctx.quadraticCurveTo(blueCube.x - blueCube.size/2, blueCube.y - blueCube.size/2, blueCube.x - blueCube.size/2 + r, blueCube.y - blueCube.size/2);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* CIRCLE MESSAGE */
let circleMsgShown=false;
const circleMsgEl = document.getElementById("circleMsg");
function showCircleMsg(){
  if(circleMsgShown) return;
  circleMsgShown = true;
  circleMsgEl.textContent = "whoa, I guess ur a circle now. HIGH FIVE!";
  let start = performance.now();
  function animateMsg(time){
    let t = (time-start)/1000;
    if(t<1){ // slide in
      circleMsgEl.style.bottom = (-50 + 50*t) + "px";
    } else if(t<11){ // stay
      circleMsgEl.style.bottom = "0px";
      circleMsgEl.style.color = `hsl(${Date.now()%360},100%,50%)`;
    } else if(t<12){ // slide out
      circleMsgEl.style.bottom = (0 - 50*(t-11)) + "px";
    } else return;
    requestAnimationFrame(animateMsg);
  }
  requestAnimationFrame(animateMsg);
}

/* rest of your game code (update, draw, player, bullets, enemies, etc.) goes here... */
// inside update(), check circle message:
function checkCircleMsg() {
  if(currentShapeSides === 100) showCircleMsg();
}
</script>
</body>
</html>
