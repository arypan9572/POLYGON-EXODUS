<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body { margin:0; padding:0; background:#0b0b0b; color:#fff; font-family:'SF Pro', sans-serif; overflow:hidden; }
canvas { display:block; }
#ui { position: fixed; top:10px; right:10px; background: rgba(0,0,0,0.7); padding:12px; border-radius:10px; width:260px; font-size:14px; }
#leaderboard { margin-top:8px; max-height:180px; overflow-y:auto; font-size:13px; position:relative; }
.lb-row { display:flex; justify-content:space-between; opacity:0.85; position:relative; animation: floatUpDown 2s infinite alternate; }
@keyframes floatUpDown { 0%{top:0px;} 100%{top:4px;} }
.comboText { position:absolute; top:10px; left:50%; transform:translateX(-50%); font-weight:bold; font-style:italic; font-size:22px; animation: floatCombo 1s ease-out forwards; pointer-events:none; }
@keyframes floatCombo { 0%{opacity:1; top:10px;} 100%{opacity:0; top:-40px;} }
button { width:100%; padding:6px; margin:4px 0; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }
button:hover{opacity:0.85;}
</style>
</head>
<body>
<div id="ui">
  <div><b>Player</b></div>
  <hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
  <hr>
  <b>Leaderboard</b>
  <div id="leaderboard"></div>
  <button id="idleBtn">IDLE MODE</button>
  <button id="exitIdleBtn" style="display:none;">EXIT IDLE MODE</button>
  <button id="saveLoadBtn">SAVE / LOAD</button>
</div>

<canvas id="game"></canvas>

<div id="savePanel" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999;">
  <div style="width:420px;background:#111;border:2px solid #555;padding:14px;margin:10% auto;border-radius:10px;">
    <b>Save / Load Game</b>
    <textarea id="saveText" style="width:100%;height:120px;margin-top:10px;background:#000;color:#0f0;font-family:monospace;resize:none;"></textarea>
    <button id="saveBtn">GENERATE SAVE</button>
    <button id="loadBtn">LOAD GAME</button>
    <button id="closeSave">CLOSE</button>
  </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
window.addEventListener('resize',()=>{canvas.width=innerWidth; canvas.height=innerHeight;});

/* PLAYER */
let player={x:canvas.width/2,y:canvas.height/2,r:18,angle:0,tokens:0,health:100,rainbow:false};
let currentShapeSides=3;

/* GAME DATA */
let bullets=[],enemies=[],particles=[];
let keys={},idleMode=false,idleInterval=null;
let combo=0,mass=0,difficulty=1,hUses=12;

/* BLUE CUBE */
let blueCube = { x: canvas.width/2, y: canvas.height/2, size:40, pulse:0 };
let circleMessageShown = false;

/* CAMERA SHAKE */
let shakeAmount=0;
function shakeCamera(amount){ shakeAmount=amount; }

/* FIRE */
function fireSingle(){ bullets.push({x:player.x,y:player.y,vx:Math.cos(player.angle)*6,vy:Math.sin(player.angle)*6,rainbow:player.rainbow}); }
function fireSpread(){ for(let i=0;i<8;i++){ const a=i*Math.PI*2/8+player.angle; bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*7,vy:Math.sin(a)*7,rainbow:player.rainbow}); }}

/* EVOLUTION */
function evolve(){ if(player.tokens<5) currentShapeSides=3; else if(player.tokens<10) currentShapeSides=4; else if(player.tokens<15) currentShapeSides=5; else if(player.tokens<20) currentShapeSides=6; else if(player.tokens<25) currentShapeSides=7; else if(player.tokens<30) currentShapeSides=8; else if(player.tokens<35) currentShapeSides=9; else if(player.tokens<40) currentShapeSides=10; else if(player.tokens<45) currentShapeSides=2; else currentShapeSides=100; }

/* CIRCLE MESSAGE */
function checkCircleMessage(){
  if(currentShapeSides===100 && !circleMessageShown){
    circleMessageShown=true;
    const msg = document.createElement('div');
    msg.textContent="whoa, I guess ur a circle now. HIGH FIVE! ðŸ˜œ";
    msg.style.position="fixed"; msg.style.bottom="20px"; msg.style.left="50%"; msg.style.transform="translateX(-50%)";
    msg.style.fontSize="22px"; msg.style.fontWeight="600"; msg.style.fontStyle="italic";
    msg.style.background="linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet)";
    msg.style.backgroundClip="text"; msg.style.webkitBackgroundClip="text"; msg.style.color="transparent";
    msg.style.textAlign="center"; msg.style.zIndex="9999"; document.body.appendChild(msg);
    setTimeout(()=>msg.remove(),10000);
  }
}

/* UPDATE */
function update(){
  if(keys.w)player.y-=4; if(keys.s)player.y+=4; if(keys.a)player.x-=4; if(keys.d)player.x+=4;
  player.angle+=0.08;

  // bullets
  for(let i=bullets.length-1;i>=0;i--){ let b=bullets[i]; b.x+=b.vx; b.y+=b.vy; if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1); }

  // spawn enemies
  if(Math.random()<0.01) enemies.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:8});

  document.getElementById('mass').textContent=mass;
  document.getElementById('tokens').textContent=player.tokens;
  document.getElementById('tier').textContent=currentShapeSides===100?"Circle":currentShapeSides;

  // blue cube pulse
  blueCube.pulse += 0.05;
}

/* DRAW */
function draw(){
  ctx.fillStyle="#0b0b0b"; ctx.fillRect(0,0,canvas.width,canvas.height);

  // blue cube
  const glow = Math.sin(blueCube.pulse)*0.5+0.5;
  ctx.save();
  ctx.shadowBlur = 20 + glow*20;
  ctx.shadowColor = `rgba(0,255,255,${0.5+glow*0.5})`;
  ctx.fillStyle="blue";
  ctx.fillRect(blueCube.x-blueCube.size/2,blueCube.y-blueCube.size/2,blueCube.size,blueCube.size);
  ctx.strokeStyle="#0ff"; ctx.lineWidth=2;
  ctx.strokeRect(blueCube.x-blueCube.size/2,blueCube.y-blueCube.size/2,blueCube.size,blueCube.size);
  ctx.restore();

  // player
  ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(player.angle);
  ctx.fillStyle=player.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#4caf50';
  ctx.beginPath();
  if(currentShapeSides===100) ctx.arc(0,0,player.r,0,Math.PI*2);
  else{ for(let i=0;i<currentShapeSides;i++){ const a=i*Math.PI*2/currentShapeSides-Math.PI/2; ctx.lineTo(Math.cos(a)*player.r,Math.sin(a)*player.r);} ctx.closePath(); }
  ctx.fill(); ctx.restore();

  // bullets
  bullets.forEach(b=>{ ctx.fillStyle=b.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff'; ctx.fillRect(b.x,b.y,3,3); });

  // enemies
  enemies.forEach(e=>{ ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); });
}

/* LOOP */
function loop(){ requestAnimationFrame(loop); update(); draw(); checkCircleMessage(); }
loop();

/* INPUT */
window.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; if(e.key===' ') fireSingle(); });
window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });
</script>
</body>
</html>
