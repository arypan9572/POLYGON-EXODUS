<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body {
  margin:0;
  padding:0;
  background:#0b0b0b;
  color:#fff;
  font-family:'SF Pro', sans-serif;
  overflow:hidden;
}
canvas { display:block; }

#ui {
  position: fixed;
  top:10px;
  right:10px;
  background: rgba(0,0,0,0.7);
  padding:12px;
  border-radius:10px;
  width:260px;
  font-size:14px;
}

#leaderboard {
  margin-top:8px;
  max-height:180px;
  overflow-y:auto;
  font-size:13px;
}

.lb-row {
  display:flex;
  justify-content:space-between;
  opacity:0.85;
  animation: floatUpDown 2s infinite alternate;
}

@keyframes floatUpDown {
  0%{transform:translateY(0);}
  100%{transform:translateY(4px);}
}

.comboText {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  font-style:italic;
  font-size:22px;
  animation: floatCombo 1s ease-out forwards;
  pointer-events:none;
}

@keyframes floatCombo {
  0%{opacity:1; transform:translate(-50%,0);}
  100%{opacity:0; transform:translate(-50%,-40px);}
}

button {
  width:100%;
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
button:hover{opacity:0.85;}
</style>
</head>
<body>

<div id="ui">
  <b>Player</b><hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
  <hr>
  <b>Leaderboard</b>
  <div id="leaderboard"></div>
  <button id="idleBtn">IDLE MODE</button>
  <button id="exitIdleBtn" style="display:none;">EXIT IDLE MODE</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth;
canvas.height = innerHeight;

window.addEventListener('resize',()=>{
  canvas.width=innerWidth;
  canvas.height=innerHeight;
});

/* ================= BACKGROUND ================= */
const bgImg = new Image();
bgImg.src = "bg.png";

const bgObj = {
  x: canvas.width/2,
  y: canvas.height/2,
  vx: (Math.random()*0.4+0.1)*(Math.random()<0.5?-1:1),
  vy: (Math.random()*0.4+0.1)*(Math.random()<0.5?-1:1),
  size: 42
};

/* ================= PLAYER ================= */
let player = {
  x:canvas.width/2,
  y:canvas.height/2,
  r:18,
  sides:3,
  angle:0,
  tokens:0,
  rainbow:false
};

let bullets=[], enemies=[], particles=[];
let keys={}, idleMode=false, idleInterval=null;
let combo=0, lastHit=0, mass=0;
let rainbowTimer=null;

/* ================= FIRE ================= */
function fireSingle(){
  const spread = player.rainbow ? 0.2 : 0;
  const shots = player.rainbow ? 4 : 1;

  for(let i=0;i<shots;i++){
    const a = player.angle + (i-1.5)*spread;
    bullets.push({
      x:player.x,
      y:player.y,
      vx:Math.cos(a)*5,
      vy:Math.sin(a)*5,
      rainbow:player.rainbow
    });
  }
}

function fireSpread(){
  for(let i=0;i<8;i++){
    const a=i*Math.PI*2/8+player.angle;
    bullets.push({
      x:player.x,
      y:player.y,
      vx:Math.cos(a)*6,
      vy:Math.sin(a)*6,
      rainbow:player.rainbow
    });
  }
}

/* ================= EVOLUTION ================= */
function evolve(){
  player.sides =
    player.tokens<5 ? 3 :
    player.tokens<10 ? 4 :
    player.tokens<20 ? 5 :
    player.tokens<50 ? 6 : 8;
}

/* ================= ENEMIES ================= */
function spawnEnemy(){
  enemies.push({
    x:Math.random()<0.5?-20:canvas.width+20,
    y:Math.random()*canvas.height,
    r:8
  });
}
setInterval(spawnEnemy,1000);

/* ================= FX ================= */
function createExplosion(x,y){
  for(let i=0;i<12;i++){
    particles.push({
      x,y,
      r:Math.random()*4+2,
      vx:(Math.random()-0.5)*4,
      vy:(Math.random()-0.5)*4,
      alpha:1
    });
  }
}

function showCombo(n){
  const d=document.createElement('div');
  d.className='comboText';
  d.textContent='COMBO x'+n;
  d.style.color=player.rainbow
    ?`hsl(${Date.now()%360},100%,50%)`
    :'#fff';
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1000);
}

/* ================= UPDATE ================= */
function update(){
  const now=performance.now();

  if(!idleMode){
    if(keys.w) player.y-=3;
    if(keys.s) player.y+=3;
    if(keys.a) player.x-=3;
    if(keys.d) player.x+=3;
  } else {
    player.x+=(canvas.width/2-player.x)*0.05;
    player.y+=(canvas.height/2-player.y)*0.05;
  }

  player.x=Math.max(player.r,Math.min(canvas.width-player.r,player.x));
  player.y=Math.max(player.r,Math.min(canvas.height-player.r,player.y));

  player.angle+=0.05;

  bullets.forEach(b=>{ b.x+=b.vx; b.y+=b.vy; });

  enemies.forEach(e=>{
    const dx=player.x-e.x, dy=player.y-e.y;
    const d=Math.hypot(dx,dy)||1;
    e.x+=dx/d*0.5;
    e.y+=dy/d*0.5;
  });

  for(let i=bullets.length-1;i>=0;i--){
    for(let j=enemies.length-1;j>=0;j--){
      if(Math.hypot(bullets[i].x-enemies[j].x, bullets[i].y-enemies[j].y) < enemies[j].r){
        createExplosion(enemies[j].x,enemies[j].y);
        bullets.splice(i,1);
        enemies.splice(j,1);

        mass++; player.tokens++; evolve();
        combo = now-lastHit<1000 ? combo+1 : 1;
        lastHit=now;

        if(combo>1) showCombo(combo);

        if(combo>=10){
          player.rainbow=true;
          clearTimeout(rainbowTimer);
          rainbowTimer=setTimeout(()=>player.rainbow=false,60000);
        }
        break;
      }
    }
  }

  if(now-lastHit>1500) combo=0;

  particles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.alpha-=0.03;
  });
  particles=particles.filter(p=>p.alpha>0);

  bgObj.x+=bgObj.vx;
  bgObj.y+=bgObj.vy;
  if(bgObj.x<bgObj.size||bgObj.x>canvas.width-bgObj.size) bgObj.vx*=-1;
  if(bgObj.y<bgObj.size||bgObj.y>canvas.height-bgObj.size) bgObj.vy*=-1;

  massEl.textContent=mass;
  tokensEl.textContent=player.tokens;
  tierEl.textContent=['Triangle','Square','Pentagon','Hexagon','Octagon'][Math.min(player.sides-3,4)];
}

/* ================= DRAW ================= */
function draw(){
  ctx.fillStyle="rgba(11,11,11,0.25)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(bgImg.complete){
    ctx.globalAlpha=0.25;
    ctx.drawImage(bgImg,bgObj.x-bgObj.size/2,bgObj.y-bgObj.size/2,bgObj.size,bgObj.size);
    ctx.globalAlpha=1;
  }

  ctx.save();
  ctx.translate(player.x,player.y);
  ctx.rotate(player.angle);
  ctx.fillStyle=player.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#4caf50';
  ctx.beginPath();
  for(let i=0;i<player.sides;i++){
    const a=i*Math.PI*2/player.sides-Math.PI/2;
    ctx.lineTo(Math.cos(a)*player.r,Math.sin(a)*player.r);
  }
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  bullets.forEach(b=>{
    ctx.fillStyle=b.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff';
    ctx.fillRect(b.x,b.y,3,3);
  });

  enemies.forEach(e=>{
    ctx.fillStyle='red';
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fill();
  });

  particles.forEach(p=>{
    ctx.fillStyle=`rgba(255,0,0,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fill();
  });
}

const massEl=document.getElementById('mass');
const tokensEl=document.getElementById('tokens');
const tierEl=document.getElementById('tier');

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();

/* ================= INPUT ================= */
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key===' '&&!idleMode) fireSingle();
  if(e.key.toLowerCase()==='h'&&!idleMode) fireSpread();
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

/* ================= IDLE ================= */
idleBtn.onclick=()=>{
  idleMode=true;
  idleBtn.style.display='none';
  exitIdleBtn.style.display='block';
  idleInterval=setInterval(()=>{
    fireSingle();
    if(combo>=10) fire
