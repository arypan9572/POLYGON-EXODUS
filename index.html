<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body {
  margin:0;
  padding:0;
  background:#0b0b0b;
  color:#fff;
  font-family:'SF Pro', sans-serif;
  overflow:hidden;
}
canvas { display:block; }

#ui {
  position: fixed;
  top:10px;
  right:10px;
  background: rgba(0,0,0,0.7);
  padding:12px;
  border-radius:10px;
  width:260px;
  font-size:14px;
}

.comboText {
  position: absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  font-style:italic;
  font-size:22px;
  animation: floatCombo 1s ease-out forwards;
  pointer-events:none;
}

@keyframes floatCombo {
  0%{opacity:1; top:10px;}
  100%{opacity:0; top:-40px;}
}

/* PING DISPLAY */
#ping {
  position: fixed;
  bottom:10px;
  right:12px;
  font-weight:bold;
  font-style:italic;
  font-size:14px;
  pointer-events:none;
}
</style>
</head>
<body>

<div id="ui">
  <div><b>Player</b></div>
  <hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
</div>

<div id="ping">PING: 0 ms</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth;
canvas.height = innerHeight;

window.addEventListener('resize',()=>{
  canvas.width=innerWidth;
  canvas.height=innerHeight;
});

/* BACKGROUND IMAGE */
const bgImg = new Image();
bgImg.src = "bg.png";

const bgObj = {
  x: canvas.width/2,
  y: canvas.height/2,
  vx: 0.25,
  vy: 0.25,
  size: 56
};

let player = {
  x:canvas.width/2,
  y:canvas.height/2,
  r:18,
  sides:3,
  angle:0,
  tokens:0,
  rainbow:false
};

let bullets=[], enemies=[], particles=[];
let keys={}, combo=0, mass=0;

/* FIRE */
function fireSingle(){
  if(player.rainbow){
    for(let i=-1;i<=2;i++){
      const a=player.angle+i*0.2;
      bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*5,vy:Math.sin(a)*5,rainbow:true});
    }
  } else {
    bullets.push({x:player.x,y:player.y,vx:Math.cos(player.angle)*5,vy:Math.sin(player.angle)*5,rainbow:false});
  }
}

/* ENEMIES */
function spawnEnemy(){
  enemies.push({
    x:Math.random()<0.5?-20:canvas.width+20,
    y:Math.random()*canvas.height,
    r:8
  });
}
setInterval(spawnEnemy,1000);

/* EXPLOSION */
function createExplosion(x,y){
  for(let i=0;i<10;i++){
    particles.push({
      x,y,
      r:Math.random()*3+2,
      vx:(Math.random()-0.5)*4,
      vy:(Math.random()-0.5)*4,
      alpha:1
    });
  }
}

/* COMBO */
function showCombo(n){
  const d=document.createElement('div');
  d.className='comboText';
  d.textContent='COMBO x'+n;
  d.style.color=`hsl(${Date.now()%360},100%,50%)`;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1000);
}

/* UPDATE */
let lastFrame = performance.now();
let ping = 0;

function update(){
  const now = performance.now();
  ping = Math.min(999, Math.round(now - lastFrame));
  lastFrame = now;

  if(keys.w) player.y-=3;
  if(keys.s) player.y+=3;
  if(keys.a) player.x-=3;
  if(keys.d) player.x+=3;
  player.angle+=0.05;

  bullets.forEach(b=>{ b.x+=b.vx; b.y+=b.vy; });
  enemies.forEach(e=>{
    const dx=player.x-e.x, dy=player.y-e.y;
    const d=Math.hypot(dx,dy)||1;
    e.x+=dx/d*0.5;
    e.y+=dy/d*0.5;
  });

  /* COLLISIONS */
  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(Math.hypot(b.x-e.x,b.y-e.y)<e.r){
        bullets.splice(bi,1);
        enemies.splice(ei,1);
        createExplosion(e.x,e.y);
        combo++; if(combo>1) showCombo(combo);
        if(combo>=10) player.rainbow=true;
      }
    });
  });

  /* HARD DESPAWN (NO LAG) */
  bullets = bullets.filter(b =>
    b.x>-20 && b.x<canvas.width+20 &&
    b.y>-20 && b.y<canvas.height+20
  );

  enemies = enemies.filter(e =>
    e.x>-40 && e.x<canvas.width+40 &&
    e.y>-40 && e.y<canvas.height+40
  );

  particles.forEach(p=>{
    p.x+=p.vx;
    p.y+=p.vy;
    p.alpha-=0.04;
  });
  particles = particles.filter(p =>
    p.alpha>0 &&
    p.x>-20 && p.x<canvas.width+20 &&
    p.y>-20 && p.y<canvas.height+20
  );

  /* BACKGROUND MOVE */
  bgObj.x+=bgObj.vx;
  bgObj.y+=bgObj.vy;
  if(bgObj.x<bgObj.size||bgObj.x>canvas.width-bgObj.size) bgObj.vx*=-1;
  if(bgObj.y<bgObj.size||bgObj.y>canvas.height-bgObj.size) bgObj.vy*=-1;

  document.getElementById('ping').style.color =
    `hsl(${Date.now()%360},100%,50%)`;
  document.getElementById('ping').textContent = `PING: ${ping} ms`;
}

/* DRAW */
function draw(){
  ctx.fillStyle="rgba(11,11,11,0.25)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(bgImg.complete){
    ctx.globalAlpha=0.25;
    ctx.drawImage(bgImg,bgObj.x-bgObj.size/2,bgObj.y-bgObj.size/2,bgObj.size,bgObj.size);
    ctx.globalAlpha=1;
  }

  ctx.save();
  ctx.translate(player.x,player.y);
  ctx.rotate(player.angle);
  ctx.fillStyle=player.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#4caf50';
  ctx.beginPath();
  for(let i=0;i<player.sides;i++){
    const a=i*Math.PI*2/player.sides-Math.PI/2;
    ctx.lineTo(Math.cos(a)*player.r,Math.sin(a)*player.r);
  }
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  bullets.forEach(b=>{
    ctx.fillStyle=b.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff';
    ctx.fillRect(b.x,b.y,3,3);
  });

  enemies.forEach(e=>{
    ctx.fillStyle='red';
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fill();
  });

  particles.forEach(p=>{
    ctx.fillStyle=`rgba(255,0,0,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fill();
  });
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();

/* INPUT */
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key===' ') fireSingle();
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
</script>
</body>
</html>
