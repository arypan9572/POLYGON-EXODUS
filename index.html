<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLYGON EXODUS</title>
<style>
html, body { margin:0; padding:0; background:#0b0b0b; color:#fff; font-family:'SF Pro', sans-serif; overflow:hidden; }
canvas { display:block; }
#ui { position: fixed; top:10px; right:10px; background: rgba(0,0,0,0.7); padding:12px; border-radius:10px; width:260px; font-size:14px; }
#leaderboard { margin-top:8px; max-height:180px; overflow-y:auto; font-size:13px; position:relative; }
.lb-row { display:flex; justify-content:space-between; opacity:0.85; position:relative; animation: floatUpDown 2s infinite alternate; }
@keyframes floatUpDown { 0%{top:0px;} 100%{top:4px;} }
.comboText { position:absolute; top:10px; left:50%; transform:translateX(-50%); font-weight:bold; font-style:italic; font-size:22px; animation: floatCombo 1s ease-out forwards; pointer-events:none; }
@keyframes floatCombo { 0%{opacity:1; top:10px;} 100%{opacity:0; top:-40px;} }
button { width:100%; padding:6px; margin:4px 0; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }
button:hover{opacity:0.85;}
</style>
</head>
<body>

<div id="ui">
  <div><b>Player</b></div>
  <hr>
  <div>Mass: <span id="mass">0</span></div>
  <div>Shape: <span id="tier">Triangle</span></div>
  <div>Tokens: <span id="tokens">0</span></div>
  <hr>
  <b>Leaderboard</b>
  <div id="leaderboard"></div>
  <button id="idleBtn">IDLE MODE</button>
  <button id="exitIdleBtn" style="display:none;">EXIT IDLE MODE</button>
  <button id="saveLoadBtn">SAVE / LOAD</button>
</div>

<canvas id="game"></canvas>

<!-- SAVE / LOAD PANEL -->
<div id="savePanel" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999;">
  <div style="width:420px;background:#111;border:2px solid #555;padding:14px;margin:10% auto;border-radius:10px;">
    <b>Save / Load Game</b>
    <textarea id="saveText" style="width:100%;height:120px;margin-top:10px;background:#000;color:#0f0;font-family:monospace;resize:none;"></textarea>
    <button id="saveBtn">GENERATE SAVE</button>
    <button id="loadBtn">LOAD GAME</button>
    <button id="closeSave">CLOSE</button>
  </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
window.addEventListener('resize',()=>{canvas.width=innerWidth; canvas.height=innerHeight;});

/* BACKGROUND */
const bgImg = new Image(); bgImg.src="bg.png";
const bgImg2 = new Image(); bgImg2.src="goonerola.png";
const bgObj={x:canvas.width/2,y:canvas.height/2,vx:(Math.random()*0.6+0.2)*(Math.random()<0.5?-1:1),vy:(Math.random()*0.6+0.2)*(Math.random()<0.5?-1:1),size:39};
const bgObj2={x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:(Math.random()*0.7+0.3)*(Math.random()<0.5?-1:1),vy:(Math.random()*0.7+0.3)*(Math.random()<0.5?-1:1),size:36};

/* PLAYER */
let player={x:canvas.width/2,y:canvas.height/2,r:18,angle:0,tokens:0,health:100,rainbow:false};
let currentShapeSides=3;

/* GAME DATA */
let bullets=[],enemies=[],particles=[],bosses=[];
let keys={},idleMode=false,idleInterval=null;
let combo=0,mass=0,difficulty=1,hUses=12;

/* CAMERA SHAKE */
let shakeAmount=0;
function shakeCamera(amount){ shakeAmount=amount; }

/* FIRE */
function fireSingle(){
  const spread=0.2;
  if(player.rainbow){
    for(let i=-1;i<=2;i++){
      const a=player.angle+i*spread;
      bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*6,vy:Math.sin(a)*6,rainbow:true});
    }
  } else {
    bullets.push({x:player.x,y:player.y,vx:Math.cos(player.angle)*6,vy:Math.sin(player.angle)*6,rainbow:false});
  }
}
function fireSpread(){
  const count=8;
  for(let i=0;i<count;i++){
    const a=i*Math.PI*2/count+player.angle;
    bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*7,vy:Math.sin(a)*7,rainbow:player.rainbow});
  }
}

/* EVOLUTION */
const shapeOrder=[3,4,5,6,7,8,9,10,2,50,60,70,80,90,101,102,103,104,100];
function evolve(){
  if(player.tokens<5) currentShapeSides=3;
  else if(player.tokens<10) currentShapeSides=4;
  else if(player.tokens<15) currentShapeSides=5;
  else if(player.tokens<20) currentShapeSides=6;
  else if(player.tokens<25) currentShapeSides=7;
  else if(player.tokens<30) currentShapeSides=8;
  else if(player.tokens<35) currentShapeSides=9;
  else if(player.tokens<40) currentShapeSides=10;
  else if(player.tokens<45) currentShapeSides=2;
  else if(player.tokens<50) currentShapeSides=50;
  else if(player.tokens<55) currentShapeSides=60;
  else if(player.tokens<60) currentShapeSides=70;
  else if(player.tokens<65) currentShapeSides=80;
  else if(player.tokens<70) currentShapeSides=90;
  else if(player.tokens<75) currentShapeSides=101;
  else if(player.tokens<80) currentShapeSides=102;
  else if(player.tokens<85) currentShapeSides=103;
  else if(player.tokens<90) currentShapeSides=104;
  else currentShapeSides=100;
}

/* ENEMIES */
function spawnEnemy(){ enemies.push({x:Math.random()<0.5?-20:canvas.width+20, y:Math.random()*canvas.height, r:8, hp:1}); }
setInterval(spawnEnemy,800);
setInterval(()=>{hUses=12;},60000);

/* BOSSES */
function spawnBoss(){
  bosses.push({x:Math.random()<0.5?-50:canvas.width+50, y:Math.random()*canvas.height, r:player.r*1.2, hp:30});
}
setInterval(spawnBoss,75000);

/* EXPLOSION */
function createExplosion(x,y){ for(let i=0;i<12;i++){ particles.push({x,y,r:Math.random()*4+2,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,alpha:1}); } }

/* COMBO */
function showCombo(n){
  const d=document.createElement('div');
  d.className='comboText';
  d.textContent='COMBO x'+n;
  d.style.color=player.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff';
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1000);
}

/* SHAPE NAMES */
function getShapeName(sides){
  switch(sides){
    case 3: return "Triangle"; case 4: return "Square"; case 5: return "Pentagon";
    case 6: return "Hexagon"; case 7: return "Heptagon"; case 8: return "Octagon";
    case 9: return "Nonagon"; case 10: return "Decagon"; case 2: return "Digon";
    case 50: return "4-sided Star"; case 60: return "6-sided Star"; case 70: return "7-sided Star";
    case 80: return "5-point Star"; case 90: return "6-point Star";
    case 101: return "Hexagram"; case 102: return "Heptagram"; case 103: return "Heart"; case 104: return "Diamond";
    case 100: return "Circle"; default: return "Unknown";
  }
}

/* UPDATE */
function update(){
  if(!idleMode){ if(keys.w)player.y-=4; if(keys.s)player.y+=4; if(keys.a)player.x-=4; if(keys.d)player.x+=4; }
  else{ player.x+=(canvas.width/2-player.x)*0.05; player.y+=(canvas.height/2-player.y)*0.05; }
  player.angle+=0.08;

  // bullets
  bullets.forEach((b,bi)=>{ b.x+=b.vx; b.y+=b.vy; if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(bi,1); });

  // enemies
  enemies.forEach((e,ei)=>{
    const dx=player.x-e.x, dy=player.y-e.y, d=Math.hypot(dx,dy)||1;
    const speed=0.7+difficulty*0.2;
    e.x+=dx/d*speed; e.y+=dy/d*speed;
    if(d<player.r+e.r){ const idx=shapeOrder.indexOf(currentShapeSides); currentShapeSides=shapeOrder[Math.max(0,idx-3)]; combo=0; player.rainbow=false; shakeCamera(5); enemies.splice(ei,1);}
    if(e.x<-50||e.x>canvas.width+50||e.y<-50||e.y>canvas.height+50) enemies.splice(ei,1);
  });

  // bullets hit enemies
  bullets.forEach((b,bi)=>{ enemies.forEach((e,ei)=>{ if(Math.hypot(b.x-e.x,b.y-e.y)<e.r){ bullets.splice(bi,1); enemies.splice(ei,1); createExplosion(e.x,e.y); mass++; player.tokens++; evolve(); combo++; if(mass%20===0)difficulty++; if(combo>1)showCombo(combo); if(combo>=35&&!player.rainbow)player.rainbow=true; } }); });

  // bosses
  bosses.forEach((b,bi)=>{
    const dx=player.x-b.x, dy=player.y-b.y, d=Math.hypot(dx,dy)||1;
    b.x+=dx/d*(0.4+difficulty*0.1); b.y+=dy/d*(0.4+difficulty*0.1);
    if(d<player.r+b.r){ shakeCamera(10); } // collision effect
  });

  // particles
  particles.forEach((p,pi)=>{ p.x+=p.vx; p.y+=p.vy; p.alpha-=0.03; if(p.alpha<=0) particles.splice(pi,1); });

  // background
  bgObj.x+=bgObj.vx; bgObj.y+=bgObj.vy; if(bgObj.x<bgObj.size||bgObj.x>canvas.width-bgObj.size) bgObj.vx*=-1; if(bgObj.y<bgObj.size||bgObj.y>canvas.height-bgObj.size) bgObj.vy*=-1;
  bgObj2.x+=bgObj2.vx; bgObj2.y+=bgObj2.vy; if(bgObj2.x<bgObj2.size||bgObj2.x>canvas.width-bgObj2.size) bgObj2.vx*=-1; if(bgObj2.y<bgObj2.size||bgObj2.y>canvas.height-bgObj2.size) bgObj2.vy*=-1;

  document.getElementById('mass').textContent=mass;
  document.getElementById('tokens').textContent=player.tokens;
  document.getElementById('tier').textContent=getShapeName(currentShapeSides);
  player.x=Math.max(player.r,Math.min(canvas.width-player.r,player.x));
  player.y=Math.max(player.r,Math.min(canvas.height-player.r,player.y));
}

/* DRAW */
function draw(){
  ctx.save();
  const shakeX=(Math.random()-0.5)*shakeAmount;
  const shakeY=(Math.random()-0.5)*shakeAmount;
  ctx.translate(shakeX,shakeY);
  shakeAmount*=0.9;

  ctx.fillStyle="rgba(11,11,11,0.25)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(bgImg.complete){ctx.globalAlpha=0.25;ctx.drawImage(bgImg,bgObj.x-bgObj.size/2,bgObj.y-bgObj.size/2,bgObj.size,bgObj.size);ctx.globalAlpha=1;}
  if(bgImg2.complete){ctx.globalAlpha=0.25;ctx.drawImage(bgImg2,bgObj2.x-bgObj2.size/2,bgObj2.y-bgObj2.size/2,bgObj2.size,bgObj2.size);ctx.globalAlpha=1;}

  drawPlayerShape();

  bullets.forEach(b=>{ctx.fillStyle=b.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#fff'; ctx.fillRect(b.x,b.y,3,3);});
  enemies.forEach(e=>{ctx.fillStyle='red';ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();});
  bosses.forEach(b=>{ 
    ctx.fillStyle='black'; ctx.strokeStyle='hsl(280,100%,80%)'; ctx.lineWidth=3; ctx.shadowColor='hsl(280,100%,70%)'; ctx.shadowBlur=6;
    ctx.beginPath(); const sides=6; for(let i=0;i<sides;i++){const a=i*Math.PI*2/sides-Math.PI/2; ctx.lineTo(Math.cos(a)*b.r, Math.sin(a)*b.r);}
    ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.shadowBlur=0;
    ctx.fillStyle='#fff'; ctx.font='14px monospace'; ctx.textAlign='center'; ctx.fillText(b.hp,b.x,b.y-b.r-5);
  });
  particles.forEach(p=>{ctx.fillStyle=`rgba(255,0,0,${p.alpha})`;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();});
  ctx.restore();
}

/* DRAW PLAYER */
function drawPlayerShape(){
  const s=currentShapeSides;
  ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(player.angle);
  ctx.fillStyle=player.rainbow?`hsl(${Date.now()%360},100%,50%)`:'#4caf50';
  ctx.beginPath();

  if([3,4,5,6,7,8,9,10].includes(s)){ for(let i=0;i<s;i++){ const a=i*Math.PI*2/s-Math.PI/2; ctx.lineTo(Math.cos(a)*player.r,Math.sin(a)*player.r); } ctx.closePath();}
  else if(s===100){ctx.arc(0,0,player.r,0,Math.PI*2);}
  else if(s===2){ctx.moveTo(-player.r,0); ctx.quadraticCurveTo(0,-player.r,player.r,0); ctx.quadraticCurveTo(0,player.r,-player.r,0); ctx.closePath();}
  else if([50,60,70,80,90,101,102].includes(s)){ let spikes; switch(s){ case 50:spikes=4;break; case 60:spikes=6;break; case 70:spikes=7;break; case 80:spikes=5;break; case 90:spikes=6;break; case 101:spikes=6;break; case 102:spikes=7;break;} for(let i=0;i<spikes*2;i++){let r=i%2===0?player.r:player.r/2;if(s===101||s===102) r=i%2===0?player.r:player.r/3;const a=i*Math.PI/spikes-Math.PI/2; ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);} ctx.closePath();}
  else if(s===103){ ctx.moveTo(0,-player.r/2); ctx.bezierCurveTo(player.r,-player.r*1.2,player.r*1.5,player.r/3,0,player.r); ctx.bezierCurveTo(-player.r*1.5,player.r/3,-player.r,-player.r*1.2,0,-player.r/2); ctx.closePath();}
  else if(s===104){ ctx.moveTo(0,-player.r); ctx.lineTo(player.r/2,0); ctx.lineTo(0,player.r); ctx.lineTo(-player.r/2,0); ctx.closePath(); }

  ctx.fill(); ctx.restore();
}

/* LOOP */
function loop(){update();draw();requestAnimationFrame(loop);}
loop();

/* INPUT */
window.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; if(e.key===' '&&!idleMode) fireSingle(); if(e.key.toLowerCase()==='h'&&!idleMode&&hUses>0){ fireSpread(); hUses--; }});
window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });

/* IDLE MODE */
document.getElementById('idleBtn').onclick=()=>{ if(idleMode) return; idleMode=true; document.getElementById('idleBtn').style.display='none'; document.getElementById('exitIdleBtn').style.display='block'; idleInterval=setInterval(()=>{ for(let i=0;i<currentShapeSides;i++) fireSingle(); if(combo>=10) fireSpread(); },1000); };
document.getElementById('exitIdleBtn').onclick=()=>{ idleMode=false; clearInterval(idleInterval); idleInterval=null; document.getElementById('exitIdleBtn').style.display='none'; document.getElementById('idleBtn').style.display='block'; };

/* SAVE / LOAD TEXT SYSTEM */
const savePanel = document.getElementById("savePanel");
const saveText  = document.getElementById("saveText");
document.getElementById("saveLoadBtn").onclick = () => { savePanel.style.display = "block"; saveText.value = ""; };
document.getElementById("closeSave").onclick = () => { savePanel.style.display = "none"; };
document.getElementById("saveBtn").onclick = () => {
  const data={mass,tokens,combo,currentShapeSides,playerRainbow:player.rainbow};
  saveText.value=btoa(JSON.stringify(data));
};
document.getElementById("loadBtn").onclick = () => {
  try{
    const data=JSON.parse(atob(saveText.value.trim()));
    mass=data.mass ?? mass; tokens=data.tokens ?? tokens; combo=data.combo ?? 0; currentShapeSides=data.currentShapeSides ?? currentShapeSides;
    player.rainbow=!!data.playerRainbow;
    savePanel.style.display="none";
  }catch{ alert("Invalid save code"); }
};
</script>
</body>
</html>
